<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Seedream V4 Edit ‚Äì KIE AI</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      background: radial-gradient(circle at top, #111827, #020617);
      color: #e5e7eb;
      padding: 24px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    .shell {
      max-width: 1200px;
      width: 100%;
      display: grid;
      grid-template-columns: minmax(0, 7fr) minmax(0, 5fr);
      gap: 24px;
    }
    @media (max-width: 900px) {
      .shell {
        grid-template-columns: 1fr;
      }
    }
    .card {
      position: relative;
      border-radius: 18px;
      padding: 24px 24px 28px;
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(18px);
    }
    h1 {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #f9fafb;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 9px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.18);
      color: #bfdbfe;
      font-size: 11px;
      margin-bottom: 10px;
    }
    .badge span {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }
    .desc { margin-bottom: 18px; color: #9ca3af; font-size: 13px; }

    .form-group { margin-bottom: 14px; }
    label { font-weight: 500; display: block; margin-bottom: 6px; font-size: 13px; color: #e5e7eb; }
    input, select, textarea {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      font-size: 13px;
      background: rgba(15, 23, 42, 0.7);
      color: #e5e7eb;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.3);
      background: rgba(15, 23, 42, 0.95);
    }
    textarea { min-height: 90px; resize: vertical; }

    .file-upload {
      border: 1.5px dashed rgba(75, 85, 99, 0.9);
      padding: 18px;
      text-align: center;
      cursor: pointer;
      border-radius: 12px;
      font-size: 13px;
      color: #9ca3af;
      background: rgba(15, 23, 42, 0.6);
      transition: border-color 0.15s, background 0.15s, transform 0.1s;
    }
    .file-upload:hover {
      border-color: #3b82f6;
      background: rgba(15, 23, 42, 0.9);
      transform: translateY(-1px);
    }

    .preview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    .thumb {
      position: relative;
      width: 72px;
      height: 72px;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: #020617;
    }
    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .thumb-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: none;
      background: rgba(15, 23, 42, 0.85);
      color: #e5e7eb;
      font-size: 11px;
      line-height: 18px;
      text-align: center;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.15s;
    }
    .thumb:hover .thumb-remove { opacity: 1; }

    button {
      background: linear-gradient(135deg, #3b82f6, #6366f1);
      color: #fff;
      padding: 10px 20px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 12px 30px rgba(37, 99, 235, 0.45);
      transition: transform 0.08s, box-shadow 0.08s, opacity 0.1s;
    }
    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(37, 99, 235, 0.6);
    }
    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
    }

    .row { display: flex; gap: 10px; }
    .row .col { flex: 1; }

    .loading {
      display: none;
      margin-top: 18px;
      text-align: center;
      font-size: 13px;
      color: #d1d5db;
    }
    .spinner {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: 3px solid rgba(55, 65, 81, 0.9);
      border-top-color: #3b82f6;
      animation: spin 1s linear infinite;
      margin: 0 auto 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .error { color: #f97373; margin-top: 6px; font-size: 12px; }

    /* Panel k·∫øt qu·∫£ b√™n ph·∫£i */
    .results-panel {
      position: relative;
      border-radius: 18px;
      padding: 18px 18px 20px;
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(18px);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .results-header h3 {
      font-size: 15px;
      font-weight: 500;
      color: #e5e7eb;
    }
    .results-sub {
      font-size: 12px;
      color: #9ca3af;
    }
    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
    }
    .result-card {
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .result-card img {
      width: 100%;
      border-radius: 8px;
      display: block;
    }
    .download-btn {
      margin-top: 2px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 11px;
      padding: 5px 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      justify-content: center;
    }
    .download-btn:hover {
      border-color: #3b82f6;
      color: #bfdbfe;
    }
    .results-empty {
      font-size: 12px;
      color: #6b7280;
      text-align: center;
      padding: 16px 4px;
    }
  </style>
</head>
<body>
  <div class="shell">
    <!-- Form b√™n tr√°i -->
    <div class="card">
      <div class="badge"><span></span> Realtime Seedream V4 Edit</div>
      <h1>Seedream V4 Edit ‚Äì KIE AI</h1>
      <p class="desc">
        Upload t·ªëi ƒëa 10 ·∫£nh tham chi·∫øu (PNG/JPG, gi·ªØ ƒë√∫ng th·ª© t·ª±), nh·∫≠p prompt v√† ch·ªçn k√≠ch th∆∞·ªõc, ƒë·ªô ph√¢n gi·∫£i. K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü khung b√™n ph·∫£i.
      </p>

      <form id="aiForm">
        <div class="form-group">
          <label>Ch·∫ø ƒë·ªô</label>
          <select id="mode" name="mode">
            <option value="create">Create ‚Äì T·∫°o m·ªõi t·ª´ nhi·ªÅu ·∫£nh tham chi·∫øu</option>
            <option value="edit" selected>Edit ‚Äì Ch·ªânh s·ª≠a theo prompt</option>
          </select>
        </div>

        <div class="form-group">
          <label>Prompt (b·∫Øt bu·ªôc)</label>
          <textarea id="prompt" name="prompt" required placeholder="M√¥ t·∫£ chi ti·∫øt ·∫£nh c·∫ßn t·∫°o/ch·ªânh s·ª≠a..."></textarea>
        </div>

        <div class="form-group">
          <label>·∫¢nh tham chi·∫øu (t·ªëi ƒëa 10, PNG/JPG, gi·ªØ ƒë√∫ng th·ª© t·ª±)</label>
          <div class="file-upload" id="fileDrop">
            üìÅ Click ƒë·ªÉ ch·ªçn ·∫£nh ho·∫∑c k√©o th·∫£ v√†o ƒë√¢y
          </div>
          <input type="file" id="images" accept="image/*" multiple style="display:none" />
          <div id="preview" class="preview"></div>
          <div id="imageError" class="error"></div>
        </div>

        <div class="row">
          <div class="col">
            <div class="form-group">
              <label>T·ª∑ l·ªá (image_size)</label>
              <select id="imageSize" name="imageSize">
                <option value="square">Square</option>
                <option value="square_hd" selected>Square HD</option>
                <option value="portrait_4_3">Portrait 3:4</option>
                <option value="portrait_3_2">Portrait 2:3</option>
                <option value="portrait_16_9">Portrait 9:16</option>
                <option value="landscape_4_3">Landscape 4:3</option>
                <option value="landscape_3_2">Landscape 3:2</option>
                <option value="landscape_16_9">Landscape 16:9</option>
                <option value="landscape_21_9">Landscape 21:9</option>
              </select>
            </div>
          </div>
          <div class="col">
            <div class="form-group">
              <label>ƒê·ªô ph√¢n gi·∫£i (image_resolution)</label>
              <select id="imageResolution" name="imageResolution">
                <option value="1K" selected>1K</option>
                <option value="2K">2K</option>
                <option value="4K">4K</option>
              </select>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Seed (t√πy ch·ªçn, ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng c·∫ßn)</label>
          <input type="number" id="seed" name="seed" placeholder="VD: 42" />
        </div>

        <button type="submit" id="submitBtn">üöÄ G·ª≠i y√™u c·∫ßu</button>
      </form>

      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>ƒêang x·ª≠ l√Ω v·ªõi KIE AI, vui l√≤ng ƒë·ª£i...</p>
      </div>
    </div>

    <!-- K·∫øt qu·∫£ b√™n ph·∫£i -->
    <aside class="results-panel">
      <div class="results-header">
        <div>
          <h3>K·∫øt qu·∫£ Seedream V4</h3>
          <p class="results-sub">·∫¢nh s·∫Ω hi·ªÉn th·ªã t·ª± ƒë·ªông sau khi x·ª≠ l√Ω xong.</p>
        </div>
      </div>
      <div id="resultImages" class="result-grid"></div>
      <div id="resultsEmpty" class="results-empty">
        Ch∆∞a c√≥ k·∫øt qu·∫£. G·ª≠i prompt v√† ·∫£nh tham chi·∫øu ƒë·ªÉ b·∫Øt ƒë·∫ßu.
      </div>
    </aside>
  </div>

  <script>
    const imagesInput = document.getElementById('images');
    const fileDrop = document.getElementById('fileDrop');
    const preview = document.getElementById('preview');
    const imageError = document.getElementById('imageError');
    const resultImages = document.getElementById('resultImages');
    const resultsEmpty = document.getElementById('resultsEmpty');
    const IMGBB_KEY = '491b3ef8be2a261efff29b2af785c845';

    // M·∫£ng gi·ªØ file ƒë∆∞·ª£c ch·ªçn (gi·ªØ khi m·ªü l·∫°i dialog)
    let selectedFiles = [];

    function renderPreview() {
      preview.innerHTML = '';
      selectedFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = e => {
          const wrapper = document.createElement('div');
          wrapper.className = 'thumb';

          const img = document.createElement('img');
          img.src = e.target.result;

          const removeBtn = document.createElement('button');
          removeBtn.className = 'thumb-remove';
          removeBtn.type = 'button';
          removeBtn.textContent = '√ó';
          removeBtn.title = 'X√≥a ·∫£nh n√†y';
          removeBtn.onclick = () => {
            selectedFiles.splice(index, 1);
            renderPreview();
          };

          wrapper.appendChild(img);
          wrapper.appendChild(removeBtn);
          preview.appendChild(wrapper);
        };
        reader.readAsDataURL(file);
      });
    }

    function addFiles(files) {
      const incoming = Array.from(files);
      if (selectedFiles.length + incoming.length > 10) {
        imageError.textContent = 'T·ªëi ƒëa ch·ªâ 10 ·∫£nh tham chi·∫øu.';
        return;
      }
      // Ch·ªâ nh·∫≠n PNG/JPG/JPEG
      const valid = incoming.filter(f => /image\/(png|jpeg|jpg)/i.test(f.type));
      if (valid.length < incoming.length) {
        imageError.textContent = 'M·ªôt s·ªë ·∫£nh kh√¥ng ph·∫£i PNG/JPG n√™n ƒë√£ b·ªã b·ªè qua.';
      }
      selectedFiles = selectedFiles.concat(valid);
      renderPreview();
    }

    // Click v√πng upload m·ªü file dialog, KH√îNG reset preview
    fileDrop.addEventListener('click', () => {
      imagesInput.click();
    });

    imagesInput.addEventListener('change', (e) => {
      imageError.textContent = '';
      if (e.target.files && e.target.files.length > 0) {
        addFiles(e.target.files);
      }
      // clear value ƒë·ªÉ l·∫ßn sau ch·ªçn l·∫°i c√πng file v·∫´n trigger change
      imagesInput.value = '';
    });

    // H·ªó tr·ª£ k√©o th·∫£
    ['dragenter', 'dragover'].forEach(evt => {
      fileDrop.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        fileDrop.style.borderColor = '#3b82f6';
      });
    });
    ['dragleave', 'drop'].forEach(evt => {
      fileDrop.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        fileDrop.style.borderColor = 'rgba(75, 85, 99, 0.9)';
      });
    });
    fileDrop.addEventListener('drop', (e) => {
      imageError.textContent = '';
      const dt = e.dataTransfer;
      if (dt && dt.files) {
        addFiles(dt.files);
      }
    });

    // Upload 1 ·∫£nh l√™n ImgBB, tr·∫£ URL
    async function uploadToImgBB(file) {
      const formData = new FormData();
      formData.append('key', IMGBB_KEY);
      formData.append('image', file);

      const res = await fetch('https://api.imgbb.com/1/upload', {
        method: 'POST',
        body: formData
      });

      const data = await res.json();
      if (!data.success) {
        throw new Error('ImgBB upload failed');
      }
      return data.data.url;
    }

    // Download ·∫£nh theo URL
    async function downloadImage(url, filename = 'seedream-output.png') {
      const res = await fetch(url);
      const blob = await res.blob();
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(link.href);
    }

    document.getElementById('aiForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      imageError.textContent = '';

      const prompt = document.getElementById('prompt').value.trim();
      if (!prompt) {
        alert('Prompt l√† b·∫Øt bu·ªôc.');
        return;
      }
      if (selectedFiles.length === 0) {
        imageError.textContent = 'C·∫ßn √≠t nh·∫•t 1 ·∫£nh tham chi·∫øu PNG/JPG.';
        return;
      }

      const submitBtn = document.getElementById('submitBtn');
      const loading = document.getElementById('loading');

      submitBtn.disabled = true;
      loading.style.display = 'block';
      resultImages.innerHTML = '';
      resultsEmpty.style.display = 'none';

      try {
        // 1) Upload t·ª´ng ·∫£nh l√™n ImgBB, gi·ªØ ƒë√∫ng th·ª© t·ª±
        const imageUrls = [];
        for (let i = 0; i < selectedFiles.length; i++) {
          const url = await uploadToImgBB(selectedFiles[i]);
          imageUrls.push(url);
        }

        // 2) G·ª≠i JSON sang n8n webhook
        const payload = {
          mode: document.getElementById('mode').value,
          prompt,
          image_size: document.getElementById('imageSize').value,
          image_resolution: document.getElementById('imageResolution').value,
          max_images: 1,
          seed: document.getElementById('seed').value || null,
          image_urls: imageUrls
        };

        const res = await fetch('https://rasp.nthang91.io.vn/webhook/60e246a1-1107-49ed-a729-19fc122fe0de', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        console.log('Response from n8n:', data);

        resultImages.innerHTML = '';
        if (data.error) {
          resultsEmpty.style.display = 'block';
          resultsEmpty.textContent = 'L·ªói: ' + (data.error.state || data.error);
        } else if (data.images && data.images.length > 0) {
          data.images.forEach((url, idx) => {
            const card = document.createElement('div');
            card.className = 'result-card';

            const img = document.createElement('img');
            img.src = url;

            const btn = document.createElement('button');
            btn.className = 'download-btn';
            btn.type = 'button';
            btn.textContent = '‚¨á T·∫£i ·∫£nh ' + (idx + 1);
            btn.onclick = () => downloadImage(url, `seedream-${idx + 1}.png`);

            card.appendChild(img);
            card.appendChild(btn);
            resultImages.appendChild(card);
          });
          resultsEmpty.style.display = 'none';
        } else {
          resultsEmpty.style.display = 'block';
          resultsEmpty.textContent = 'Kh√¥ng nh·∫≠n ƒë∆∞·ª£c URL ·∫£nh t·ª´ server.';
        }
      } catch (err) {
        alert('L·ªói: ' + err.message);
        console.error(err);
        resultsEmpty.style.display = 'block';
        resultsEmpty.textContent = 'ƒê√£ x·∫£y ra l·ªói khi x·ª≠ l√Ω y√™u c·∫ßu.';
      } finally {
        submitBtn.disabled = false;
        loading.style.display = 'none';
      }
    });
  </script>
</body>
</html>

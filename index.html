<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
  <meta charset="UTF-8" />
  <title>AI Image Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="style.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js"></script>
  <script defer src="ai-app.js"></script>
</head>
<body class="dark" x-data="aiApp()" x-init="init()" x-cloak>
  <div class="app-layout">
    <!-- LEFT: MAIN FORM -->
    <div class="container">
      <h1>AI Image Generator</h1>

      <!-- MESSAGES -->
      <template x-if="errorMessage">
        <div class="error-message" x-text="errorMessage"></div>
      </template>
      <template x-if="successMessage">
        <div class="success-message" x-text="successMessage"></div>
      </template>

      <!-- PROMPT -->
      <div class="form-group">
        <label for="prompt">Prompt</label>
        <textarea id="prompt" x-model="prompt" placeholder="Nhập prompt để tạo ảnh..."></textarea>
      </div>

      <!-- NEGATIVE PROMPT -->
      <div class="form-group">
        <label for="negativePrompt">Negative prompt (tuỳ chọn)</label>
        <textarea id="negativePrompt" x-model="negativePrompt" placeholder="Những thứ không muốn xuất hiện..."></textarea>
      </div>

      <!-- ASPECT RATIO -->
      <div class="form-group">
        <label>Khung ảnh</label>
        <div class="aspect-options">
          <label class="aspect-option">
            <input type="radio" name="aspect_ratio" value="landscape" x-model="aspectRatio" />
            <span>Ngang (16:9)</span>
          </label>
          <label class="aspect-option">
            <input type="radio" name="aspect_ratio" value="portrait" x-model="aspectRatio" />
            <span>Dọc (9:16)</span>
          </label>
        </div>
      </div>

      <!-- IMAGE UPLOAD SLOTS -->
      <div class="image-slots-container">
        <template x-for="(imageSlot, index) in imageSlots" :key="imageSlot.id">
          <div class="image-item">
            <div class="image-preview">
              <template x-if="imageSlot.previewUrl">
                <img :src="imageSlot.previewUrl" alt="Preview" />
              </template>
              <template x-if="!imageSlot.previewUrl">
                <span class="placeholder-text">Chưa có ảnh. Nhấn "Chọn ảnh" để tải lên.</span>
              </template>
              <template x-if="imageSlot.sizeInfo">
                <div class="image-size-badge" x-text="imageSlot.sizeInfo"></div>
              </template>
            </div>

            <div class="image-actions">
              <button type="button" class="btn-upload" @click="$refs['fileInput' + imageSlot.id].click()">
                Chọn ảnh
              </button>
              <button
                type="button"
                class="btn-delete"
                @click="clearImageSlot(index)"
                x-bind:disabled="!imageSlot.file"
              >
                Xoá
              </button>
            </div>

            <input
              type="file"
              accept="image/*"
              class="hidden"
              :ref="'fileInput' + imageSlot.id"
              @change="handleFileChange($event, index)"
            />
          </div>
        </template>

        <button type="button" class="add-image-btn" @click="addImageSlot()" x-show="imageSlots.length < 3">
          + Thêm ảnh tham chiếu
        </button>
      </div>

      <!-- GENERATE BUTTON -->
      <button
        type="button"
        class="btn-generate"
        @click="generateImage()"
        :disabled="isGenerating || !prompt.trim()"
      >
        <span x-show="isGenerating" class="loading-spinner"></span>
        <span x-text="isGenerating ? 'Đang tạo ảnh...' : 'Tạo ảnh'"></span>
        <span x-show="isGenerating && elapsedTime" class="timer-badge" x-text="elapsedTime"></span>
      </button>

      <!-- OPTIONAL: CLEAR FORM MANUAL -->
      <button type="button" class="btn-clear-form" @click="clearForm()" x-show="prompt || negativePrompt || hasAnyImage">
        Xoá form
      </button>

      <!-- RESULTS -->
      <div class="results-section">
        <h3>Kết quả gần đây</h3>
        <template x-if="results.length === 0">
          <div class="empty-state">
            Chưa có ảnh nào được tạo.
          </div>
        </template>
        <div class="results-grid" x-show="results.length > 0">
          <template x-for="(item, idx) in results" :key="item.id">
            <img
              class="result-thumb"
              :src="item.imageUrl"
              alt="Kết quả"
              @click="openPreview(item)"
            />
          </template>
        </div>
      </div>
    </div>

    <!-- RIGHT: HISTORY -->
    <div class="history-panel">
      <div class="history-header">
        <h3>Lịch sử request</h3>
        <button type="button" class="btn-clear-history" @click="clearHistory()" x-show="history.length > 0">
          Xoá lịch sử
        </button>
      </div>
      <template x-if="history.length === 0">
        <div class="empty-state">
          Chưa có lịch sử nào.
        </div>
      </template>
      <div class="history-list" x-show="history.length > 0">
        <template x-for="item in history" :key="item.id">
          <div class="history-item">
            <div class="history-prompt" x-text="item.prompt"></div>
            <div class="history-meta">
              <span x-text="item.time"></span>
              <span x-text="item.aspect_ratio === 'landscape' ? 'Ngang' : 'Dọc'"></span>
            </div>
          </div>
        </template>
      </div>
    </div>
  </div>

  <!-- MODAL PREVIEW -->
  <div
    class="modal"
    x-show="showModal"
    x-transition
    @keydown.escape.window="closePreview()"
  >
    <div class="modal-overlay" @click="closePreview()"></div>
    <div class="modal-content-box">
      <button class="close-btn" type="button" @click="closePreview()">×</button>

      <!-- ẢNH Ở TRÊN -->
      <div class="modal-image-wrapper">
        <img :src="selectedResult?.imageUrl" alt="Kết quả" class="modal-image" />
      </div>

      <!-- PROMPT Ở DƯỚI -->
      <div class="modal-prompt">
        <label class="modal-label">Prompt đã dùng</label>
        <textarea
          class="modal-prompt-text"
          x-text="selectedResult?.prompt"
          readonly
          @click="$event.target.select()"
        ></textarea>
        <button
          type="button"
          class="btn-secondary mt-2"
          @click="copyPrompt()"
        >
          Copy prompt
        </button>
      </div>

      <!-- NÚT DOWNLOAD Ở CUỐI -->
      <div class="modal-actions">
        <a
          :href="selectedResult?.imageUrl"
          download="ai-image.png"
          class="download-btn"
        >
          Tải ảnh
        </a>
      </div>
    </div>
  </div>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Seedream V4 Edit ‚Äì KIE AI</title>
  <style>
    /* ... To√†n b·ªô CSS nh∆∞ b·∫£n tr∆∞·ªõc, gi·ªØ nguy√™n ... */
    /* Th√™m c√°c class cho Auto label, highlight modal ... (tƒÉng usability) */
    .auto-label {
      padding: 2px 7px;
      border-radius: 7px;
      background: #e0e7ff;
      color: #1e293b;
      font-size: 11px;
      margin-left: 7px;
      font-weight: 600;
      box-shadow: 0 1px 5px #6366f13b;
      display: inline-block;
    }
    .modal-overlay { /* gi·ªØ nh∆∞ m·ªçi modal preview ·ªü c√°c b·∫£n tr∆∞·ªõc */ }
    /* ... gi·ªØ c√°c class modal ... */
    /* C√°c class CSS b√™n tr√™n ƒë·ªÅu ƒë∆∞·ª£c gi·ªØ nguy√™n t·ª´ b·∫£n giao di·ªán ƒë·∫πp tr∆∞·ªõc ƒë√≥ */
  </style>
</head>
<body>
  <div class="shell">
    <!-- Form b√™n tr√°i -->
    <div class="card">
      <div class="badge"><span></span> Realtime Seedream V4 Edit</div>
      <h1>Seedream V4 Edit ‚Äì KIE AI</h1>
      <p class="desc">
        Upload t·ªëi ƒëa 10 ·∫£nh tham chi·∫øu (PNG/JPG, gi·ªØ ƒë√∫ng th·ª© t·ª±), nh·∫≠p prompt. 
        <strong>B·∫°n c√≥ th·ªÉ d√°n (Ctrl+V) tr·ª±c ti·∫øp t·ª´ clipboard, ho·∫∑c k√©o & th·∫£.</strong>
      </p>

      <form id="aiForm">
        <div class="form-group">
          <label>Ch·∫ø ƒë·ªô</label>
          <select id="mode" name="mode">
            <option value="create">Create ‚Äì T·∫°o m·ªõi t·ª´ nhi·ªÅu ·∫£nh tham chi·∫øu</option>
            <option value="edit" selected>Edit ‚Äì Ch·ªânh s·ª≠a theo prompt</option>
          </select>
        </div>
        <div class="form-group">
          <label>Prompt (b·∫Øt bu·ªôc)</label>
          <textarea id="prompt" name="prompt" required placeholder="M√¥ t·∫£ chi ti·∫øt ·∫£nh c·∫ßn t·∫°o/ch·ªânh s·ª≠a..."></textarea>
        </div>
        <div class="form-group">
          <label>·∫¢nh tham chi·∫øu (t·ªëi ƒëa 10 PNG/JPG)</label>
          <div class="file-upload" id="fileDrop">
            üìÅ Click ƒë·ªÉ ch·ªçn ·∫£nh ho·∫∑c k√©o th·∫£ v√†o ƒë√¢y
          </div>
          <input type="file" id="images" accept="image/*" multiple style="display:none" />
          <div id="preview" class="preview"></div>
          <div id="imageError" class="error"></div>
        </div>
        <div class="form-group">
          <label>
            T·ª∑ l·ªá (image_size)
            <span class="auto-label" id="imageSizeAutoLabel">Auto</span>
          </label>
          <select id="imageSize" name="imageSize">
            <option value="" selected>Auto (theo ratio ·∫£nh g·ªëc)</option>
            <option value="square">Square</option>
            <option value="square_hd">Square HD</option>
            <option value="portrait_4_3">Portrait 3:4</option>
            <option value="portrait_3_2">Portrait 2:3</option>
            <option value="portrait_16_9">Portrait 9:16</option>
            <option value="landscape_4_3">Landscape 4:3</option>
            <option value="landscape_3_2">Landscape 3:2</option>
            <option value="landscape_16_9">Landscape 16:9</option>
            <option value="landscape_21_9">Landscape 21:9</option>
          </select>
        </div>
        <div class="row">
          <div class="col">
            <div class="form-group">
              <label>ƒê·ªô ph√¢n gi·∫£i (image_resolution)</label>
              <select id="imageResolution" name="imageResolution">
                <option value="1K" selected>1K</option>
                <option value="2K">2K</option>
                <option value="4K">4K</option>
              </select>
            </div>
          </div>
        </div>

        <button type="submit" id="submitBtn">üöÄ G·ª≠i y√™u c·∫ßu</button>
      </form>
      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>ƒêang x·ª≠ l√Ω v·ªõi KIE AI, vui l√≤ng ƒë·ª£i...</p>
      </div>
    </div>

    <!-- K·∫øt qu·∫£ b√™n ph·∫£i -->
    <aside class="results-panel">
      <div class="results-header">
        <div>
          <h3>K·∫øt qu·∫£ Seedream V4</h3>
          <p class="results-sub">·∫¢nh s·∫Ω hi·ªÉn th·ªã t·ª± ƒë·ªông sau khi x·ª≠ l√Ω xong. Nh·∫•n v√†o ·∫£nh ƒë·ªÉ xem to h∆°n.</p>
        </div>
      </div>
      <div id="resultImages" class="result-grid"></div>
      <div id="resultsEmpty" class="results-empty">
        Ch∆∞a c√≥ k·∫øt qu·∫£. G·ª≠i prompt v√† ·∫£nh ƒë·ªÉ b·∫Øt ƒë·∫ßu.
      </div>
    </aside>
  </div>

  <!-- Modal zoom ·∫£nh -->
  <div class="modal-overlay" id="modalOverlay">
    <img id="modalImg" src="" alt="Preview" />
  </div>
  <div class="toast" id="toast"></div>

  <script>
    const imagesInput = document.getElementById('images');
    const fileDrop = document.getElementById('fileDrop');
    const preview = document.getElementById('preview');
    const imageError = document.getElementById('imageError');
    const resultImages = document.getElementById('resultImages');
    const resultsEmpty = document.getElementById('resultsEmpty');
    const imageSizeSelect = document.getElementById('imageSize');
    const imageSizeAutoLabel = document.getElementById('imageSizeAutoLabel');
    const modalOverlay = document.getElementById('modalOverlay');
    const modalImg = document.getElementById('modalImg');
    const toast = document.getElementById('toast');
    const IMGBB_KEY = '491b3ef8be2a261efff29b2af785c845';

    let selectedFiles = [];

    function showToast(msg, duration = 3000) {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }

    function renderPreview() {
      preview.innerHTML = '';
      selectedFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = e => {
          const wrapper = document.createElement('div');
          wrapper.className = 'thumb';
          const img = document.createElement('img');
          img.src = e.target.result;
          const removeBtn = document.createElement('button');
          removeBtn.className = 'thumb-remove';
          removeBtn.type = 'button';
          removeBtn.textContent = '√ó';
          removeBtn.title = 'X√≥a ·∫£nh n√†y';
          removeBtn.onclick = () => {
            selectedFiles.splice(index, 1);
            renderPreview();
          };
          wrapper.appendChild(img);
          wrapper.appendChild(removeBtn);
          preview.appendChild(wrapper);
        };
        reader.readAsDataURL(file);
      });
    }

    function getRatioFromImageSize(sizePreset) {
      const map = {
        'square': 1.0, 'square_hd': 1.0,
        'portrait_4_3': 0.75, 'portrait_3_2': 0.67, 'portrait_16_9': 0.56,
        'landscape_4_3': 1.33, 'landscape_3_2': 1.5, 'landscape_16_9': 1.78, 'landscape_21_9': 2.33
      };
      return map[sizePreset] || 1.0;
    }

    // Pad ·∫£nh g·ªëc v·ªÅ t·ª∑ l·ªá target b·∫±ng Canvas
    async function padImageToRatio(file, targetRatio) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const origW = img.width;
            const origH = img.height;
            const origRatio = origW / origH;
            let newW, newH;
            if (origRatio > targetRatio) {
              newW = origW;
              newH = Math.round(origW / targetRatio);
            } else {
              newH = origH;
              newW = Math.round(origH * targetRatio);
            }
            const canvas = document.createElement('canvas');
            canvas.width = newW;
            canvas.height = newH;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, newW, newH);
            const x = (newW - origW) / 2;
            const y = (newH - origH) / 2;
            ctx.drawImage(img, x, y);
            canvas.toBlob((blob) => {
              const paddedFile = new File([blob], file.name, { type: file.type });
              resolve(paddedFile);
            }, file.type);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    function addFiles(files) {
      const incoming = Array.from(files);
      if (selectedFiles.length + incoming.length > 10) {
        imageError.textContent = 'T·ªëi ƒëa ch·ªâ 10 ·∫£nh tham chi·∫øu.';
        return;
      }
      const valid = incoming.filter(f => /image\/(png|jpeg|jpg)/i.test(f.type));
      if (valid.length < incoming.length) {
        imageError.textContent = 'M·ªôt s·ªë ·∫£nh kh√¥ng ph·∫£i PNG/JPG n√™n ƒë√£ b·ªã b·ªè qua.';
      }
      selectedFiles = selectedFiles.concat(valid);
      renderPreview();
    }

    fileDrop.addEventListener('click', () => imagesInput.click());
    imagesInput.addEventListener('change', (e) => {
      imageError.textContent = '';
      if (e.target.files && e.target.files.length > 0) {
        addFiles(e.target.files);
      }
      imagesInput.value = '';
    });
    ['dragenter', 'dragover'].forEach(evt => {
      fileDrop.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        fileDrop.style.borderColor = '#3b82f6';
      });
    });
    ['dragleave', 'drop'].forEach(evt => {
      fileDrop.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        fileDrop.style.borderColor = 'rgba(75, 85, 99, 0.9)';
      });
    });
    fileDrop.addEventListener('drop', (e) => {
      imageError.textContent = '';
      const dt = e.dataTransfer;
      if (dt && dt.files) {
        addFiles(dt.files);
      }
    });

    document.addEventListener('paste', (e) => {
      const items = e.clipboardData.items;
      const files = [];
      for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
          const blob = items[i].getAsFile();
          if (blob) {
            files.push(blob);
          }
        }
      }
      if (files.length > 0) {
        imageError.textContent = '';
        addFiles(files);
        showToast('‚úÖ ƒê√£ paste ' + files.length + ' ·∫£nh t·ª´ clipboard.');
      }
    });

    // Download v·ªõi feedback
    async function downloadImage(url, filename = 'seedream-output.png', btnEl) {
      try {
        btnEl.disabled = true;
        btnEl.textContent = '‚è≥ ƒêang t·∫£i...';
        const res = await fetch(url);
        const blob = await res.blob();
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        link.remove();
        URL.revokeObjectURL(link.href);
        showToast('‚úÖ ƒê√£ t·∫£i ·∫£nh: ' + filename);
      } catch (err) {
        showToast('‚ùå L·ªói t·∫£i ·∫£nh: ' + err.message);
      } finally {
        btnEl.disabled = false;
        btnEl.textContent = '‚¨á T·∫£i ·∫£nh';
      }
    }

    // Modal zoom
    function openZoomModal(src) {
      modalImg.src = src;
      modalOverlay.classList.add('show');
    }
    function closeZoomModal() {
      modalOverlay.classList.remove('show');
      modalImg.src = '';
    }
    modalOverlay.addEventListener('click', closeZoomModal);

    // Highlight Auto khi ch·ªçn
    imageSizeSelect.addEventListener('change', function() {
      if (!this.value) {
        imageSizeAutoLabel.style.background = '#e0e7ff';
        imageSizeAutoLabel.style.color = '#1e293b';
        imageSizeAutoLabel.textContent = 'Auto';
      } else {
        imageSizeAutoLabel.style.background = '#6366f1';
        imageSizeAutoLabel.style.color = '#fff';
        imageSizeAutoLabel.textContent = this.value;
      }
    });

    // H√†m upload ·∫£nh ‚Äì n·∫øu auto th√¨ pad
    async function uploadToImgBB(file) {
      const formData = new FormData();
      formData.append('key', IMGBB_KEY);
      formData.append('image', file);
      const res = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: formData });
      const data = await res.json();
      if (!data.success) throw new Error('ImgBB upload failed');
      return data.data.url;
    }

    document.getElementById('aiForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      imageError.textContent = '';
      const prompt = document.getElementById('prompt').value.trim();
      if (!prompt) {
        alert('Prompt l√† b·∫Øt bu·ªôc.');
        return;
      }
      if (selectedFiles.length === 0) {
        imageError.textContent = 'C·∫ßn √≠t nh·∫•t 1 ·∫£nh tham chi·∫øu PNG/JPG.';
        return;
      }
      const submitBtn = document.getElementById('submitBtn');
      const loading = document.getElementById('loading');
      submitBtn.disabled = true;
      loading.style.display = 'block';
      resultImages.innerHTML = '';
      resultsEmpty.style.display = 'none';

      const ratioPreset = imageSizeSelect.value;
      const autoPad = !ratioPreset; // Auto n·∫øu kh√¥ng ch·ªçn t·ª∑ l·ªá

      try {
        // Upload t·ª´ng ·∫£nh (pad n·∫øu auto)
        const imageUrls = [];
        for (let i = 0; i < selectedFiles.length; i++) {
          let fileToSend = selectedFiles[i];
          if (autoPad) {
            // Detect ratio t·ª´ ·∫£nh
            const ratio = await new Promise((res) => {
              const reader = new FileReader();
              reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => { res(img.width / img.height); };
                img.src = ev.target.result;
              };
              reader.readAsDataURL(fileToSend);
            });
            // Ch·ªçn preset g·∫ßn nh·∫•t
            const delta = [1.0, 0.75, 0.67, 0.56, 1.33, 1.5, 1.78, 2.33];
            let closest = delta[0], idx = 0;
            for (let j = 0; j < delta.length; j++) {
              if (Math.abs(ratio - delta[j]) < Math.abs(ratio - closest)) {
                closest = delta[j]; idx = j;
              }
            }
            // Pad v·ªÅ ƒë√∫ng ratio g·∫ßn nh·∫•t
            fileToSend = await padImageToRatio(fileToSend, closest);
          }
          const url = await uploadToImgBB(fileToSend);
          imageUrls.push(url);
        }

        // G·ª≠i JSON sang webhook
        const payload = {
          mode: document.getElementById('mode').value,
          prompt,
          image_size: ratioPreset || '', // Auto g·ª≠i '', server c√≥ th·ªÉ set m·∫∑c ƒë·ªãnh (b·∫°n ch·ªânh params ph√≠a backend n·∫øu c·∫ßn)
          image_resolution: document.getElementById('imageResolution').value || '1K',
          max_images: 1,
          image_urls: imageUrls
        };
        const res = await fetch('https://rasp.nthang91.io.vn/webhook/60e246a1-1107-49ed-a729-19fc122fe0de', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        console.log('Response from n8n:', data);

        resultImages.innerHTML = '';
        if (data.error) {
          resultsEmpty.style.display = 'block';
          resultsEmpty.textContent = 'L·ªói: ' + (data.error.state || data.error);
        } else if (data.images && data.images.length > 0) {
          // Show image full-width (auto zoom)
          data.images.forEach((url, idx) => {
            const card = document.createElement('div');
            card.className = 'result-card';
            const img = document.createElement('img');
            img.src = url;
            img.onclick = () => openZoomModal(url);
            card.appendChild(img);
            const btn = document.createElement('button');
            btn.className = 'download-btn';
            btn.type = 'button';
            btn.textContent = '‚¨á T·∫£i ·∫£nh';
            btn.onclick = function() {
              downloadImage(url, `seedream-${idx + 1}.png`, btn);
            };
            card.appendChild(btn);
            resultImages.appendChild(card);
          });
          resultsEmpty.style.display = 'none';
          // Auto open preview modal sau khi nh·∫≠n k·∫øt qu·∫£
          openZoomModal(data.images[0]);
          showToast('‚úÖ X·ª≠ l√Ω xong! Nh·∫•n v√†o ·∫£nh ƒë·ªÉ ph√≥ng to.');
        } else {
          resultsEmpty.style.display = 'block';
          resultsEmpty.textContent = 'Kh√¥ng nh·∫≠n ƒë∆∞·ª£c URL ·∫£nh t·ª´ server.';
        }
      } catch (err) {
        alert('L·ªói: ' + err.message);
        resultsEmpty.style.display = 'block';
        resultsEmpty.textContent = 'ƒê√£ x·∫£y ra l·ªói khi x·ª≠ l√Ω y√™u c·∫ßu.';
      } finally {
        submitBtn.disabled = false;
        loading.style.display = 'none';
      }
    });
  </script>
</body>
</html>
